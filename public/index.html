<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bejesus IRC Channel</title>
  <link rel="stylesheet" href="css/irc.css" >
</head>
<body onload="body_loaded();">
  <div id="top_section">
    <div id="nick_list">
      <ol id="nick_ol">
      </ol>
    </div>
    <table id="chat_body">
    </table>
  </div>
  <form id="chat_bar" onsubmit="handleSubmit(); return false;">
    <input type="text" id="text_input" size="80">
    <button type="submit">Send</button>
  </form>

<div id="js">
<script src="/socket.io/socket.io.js"></script>
  <script>
    var sock = null;
    var rv = null;
    var nickname = null;
    var chatBody = null;
    var textInput = null;
    var body_loaded = function () {
      sock = new io.Socket();
      sock.on('message', handleMessage);
      sock.connect();
      chatBody = document.getElementById('chat_body');
      textInput = document.getElementById('text_input');
    };
    var getNickname = function () {
      var name = prompt("Please enter your nickname:", "");
      switch (name) {
        case "":
          alert("You did not input a nickname, please reload if you wish to connect.");
          sock.disconnect();
          return null;
          break;
        case null:
          alert("Login cancelled, please reload if you wish to connect.");
          sock.disconnect();
          return null;
          break;
        default:
          return name;
          break;
      }
    };
    var appendMessage = function (from, message, s) {
      var row = document.createElement('tr');
      if (typeof s != 'undefined' && s == true) {
        row.className = 'me';
      }
      row.innerHTML = ''
          + '<th class="author">' + from + '</th>'
          + '<td class="msg">' + message + '</td>';
      chatBody.appendChild(row);
      scrollBody();
    }
    var handleMessage = function (data) {
      var obj = JSON.parse(data);
      if (nickname === null) {
        var tmp = getNickname();
        if (tmp !== null) {
          nickname = tmp;
          rv = sock.send(JSON.stringify({ nickname: nickname }));
        }
      } else {
        if (obj.hasOwnProperty('messagetype')) {
          switch (obj.messagetype) {
            case "message":
              appendMessage(obj.from, obj.message, false);
              break;
            default:
              alert(data);
              break;
          }
        } else {
          alert(data);
        }
      }
    };
    var sendMessage = function () {
      appendMessage(nickname, textInput.value, true);
      sock.send(JSON.stringify({
        messagetype: "message",
        message: textInput.value
      }));
      textInput.value = "";
    };
    var handleSubmit = function (e) {
      if (window.event) {
        e = window.event;
      }
      if (textInput.value !== '') {
        sendMessage();
      }
    }
    var scrollBody = function() {
      document.body.scrollTop = document.body.clientHeight;
    }
  </script>
</div>
</body>
</html>